<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cash Flow Tracker</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
    }
    td[contenteditable="true"] {
      background-color: #f9f9f9;
      cursor: text;
    }
    .delete-btn {
      background-color: #ff4444;
      color: white;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
    }
    .delete-btn:hover {
      background-color: #cc0000;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>Cash Flow Entries</h1>
    <a href="/ideas" style="background: #667eea; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: 600;">ðŸ’¡ Idea Capture</a>
  </div>

  <table id="cashflow-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Amount</th>
        <th>Description</th>
        <th>Category</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in entries %}
      <tr data-id="{{ entry.id }}">
        <td contenteditable="true" class="editable" data-field="date">{{ entry.date.strftime('%Y-%m-%d') }}</td>
        <td contenteditable="true" class="editable" data-field="amount">{{ "%.2f"|format(entry.amount) }}</td>
        <td contenteditable="true" class="editable" data-field="description">{{ entry.description }}</td>
        <td contenteditable="true" class="editable" data-field="category">{{ entry.category }}</td>
        <td contenteditable="true" class="editable" data-field="notes">{{ entry.notes }}</td>
        <td><button class="delete-btn" onclick="deleteEntry({{ entry.id }})">Delete</button></td>
      </tr>
      {% endfor %}
      <tr id="input-row">
        <td><input type="date" id="input-date" required /></td>
        <td><input type="number" step="0.01" id="input-amount" required /></td>
        <td><input type="text" id="input-description" /></td>
        <td><input type="text" id="input-category" /></td>
        <td><input type="text" id="input-notes" /></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <script>
    // Focus date input on page load
    document.getElementById('input-date').focus();

    // Add new entry on Enter keypress in input row
    const inputs = document.querySelectorAll('#input-row input');
    inputs.forEach(input => {
      input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();

          const date = document.getElementById('input-date').value;
          const amount = document.getElementById('input-amount').value;
          const description = document.getElementById('input-description').value;
          const category = document.getElementById('input-category').value;
          const notes = document.getElementById('input-notes').value;

          if (!date || !amount) {
            alert('Date and Amount are required!');
            return;
          }

          const data = { date, amount, description, category, notes };

          fetch('/add-ajax', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => { throw err; });
            }
            return response.json();
          })
          .then(newEntry => {
            const tbody = document.querySelector('#cashflow-table tbody');
            const inputRow = document.getElementById('input-row');

            // Create new row
            const tr = document.createElement('tr');
            tr.setAttribute('data-id', newEntry.id);

            ['date', 'amount', 'description', 'category', 'notes'].forEach(field => {
              const td = document.createElement('td');
              td.classList.add('editable');
              td.setAttribute('contenteditable', 'true');
              td.setAttribute('data-field', field);
              td.textContent = field === 'amount' ? parseFloat(newEntry[field]).toFixed(2) : newEntry[field];
              tr.appendChild(td);
            });

            // Add delete button
            const deleteTd = document.createElement('td');
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = function() { deleteEntry(newEntry.id); };
            deleteTd.appendChild(deleteBtn);
            tr.appendChild(deleteTd);

            tbody.insertBefore(tr, inputRow);

            // Clear inputs and focus date
            inputs.forEach(i => i.value = '');
            document.getElementById('input-date').focus();

            // Attach inline editing events to new row's cells
            attachInlineEditListeners(tr.querySelectorAll('td.editable'));
          })
          .catch(error => {
            alert('Error adding entry: ' + (error.error || error));
          });
        }
      });
    });

    // Delete entry function
    function deleteEntry(entryId) {
      if (confirm('Are you sure you want to delete this entry?')) {
        fetch(`/delete/${entryId}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw err; });
          }
          return response.json();
        })
        .then(() => {
          // Remove the row from the table
          const row = document.querySelector(`tr[data-id="${entryId}"]`);
          if (row) {
            row.remove();
          }
        })
        .catch(error => {
          alert('Error deleting entry: ' + (error.error || error));
        });
      }
    }

    // Validate date format YYYY-MM-DD
    function isValidDate(dateString) {
      return /^\d{4}-\d{2}-\d{2}$/.test(dateString);
    }

    // Add inline editing save on blur for given editable cells
    function attachInlineEditListeners(cells) {
      cells.forEach(td => {
        td.addEventListener('blur', function() {
          const newValue = td.textContent.trim();
          const field = td.getAttribute('data-field');
          const row = td.closest('tr');
          const entryId = row.getAttribute('data-id');

          if (field === 'date' && !isValidDate(newValue)) {
            alert('Invalid date format. Use YYYY-MM-DD.');
            td.textContent = td.getAttribute('data-original') || '';
            return;
          }
          if (field === 'amount' && isNaN(parseFloat(newValue))) {
            alert('Amount must be a number.');
            td.textContent = td.getAttribute('data-original') || '';
            return;
          }

          const updateData = {};
          updateData[field] = newValue;
          td.setAttribute('data-original', newValue);

          fetch(`/update/${entryId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => { throw err; });
            }
            return response.json();
          })
          .catch(error => {
            alert('Error updating entry: ' + (error.error || error));
            td.textContent = td.getAttribute('data-original') || '';
          });
        });

        td.addEventListener('focus', function() {
          td.setAttribute('data-original', td.textContent.trim());
        });
      });
    }

    // Attach listeners on existing rows on page load
    attachInlineEditListeners(document.querySelectorAll('td.editable'));
  </script>
</body>
</html>
