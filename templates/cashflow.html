<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="theme-color" content="#F2EBDD">
  <title>Cash Flow Ledger</title>

  <style>
    body {
      font-family: Segoe UI, Tahoma, sans-serif;
      background: #9CAF88;
      padding: 24px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      border: 1px solid #9E9E9E;
    }
    .excel-header {
      background: #4A6741;
      color: #fff;
      padding: 14px;
      font-weight: 600;
      text-align: center;
      position: relative;
    }
    .export-btn {
      position: absolute;
      right: 20px;
      top: 14px;
      color: #fff;
      border: 1px solid #fff;
      padding: 4px 10px;
      text-decoration: none;
      font-size: 11px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5pt;
    }
    th, td {
      border: 1px solid #C0C0C0;
      padding: 6px 8px;
    }
    thead {
      background: #4A6741;
      color: #fff;
    }
    tbody tr:nth-child(odd):not(#input-row) { background: #A8CC9E; }
    tbody tr:nth-child(even):not(#input-row) { background: #E8F5C4; }
    .number { text-align: right; font-family: Courier New, monospace; }
    #input-row { background: #FFD018; }
    .save-btn { display:none; }
  </style>
</head>

<body>
<div class="container">

  <div class="excel-header">
    Cash Flow Ledger
    <a href="/export-csv" class="export-btn">Export CSV</a>
  </div>

  <table id="cashflow-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Amount</th>
        <th>Running Balance</th>
        <th>Description</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>

      <tr id="input-row">
        <td><input id="input-date" type="date"></td>
        <td><input id="input-amount" type="number" step="0.01"></td>
        <td></td>
        <td><input id="input-description"></td>
        <td><input id="input-notes"></td>
        <td></td>
      </tr>

      {% for entry in entries %}
      <tr data-id="{{ entry.id }}">
        <td contenteditable="true" data-field="date">{{ entry.date.strftime('%Y-%m-%d') }}</td>
        <td contenteditable="true" class="number" data-field="amount">{{ "%.2f"|format(entry.amount) }}</td>
        <td class="number balance-cell">0.00</td>
        <td contenteditable="true" data-field="description">{{ entry.description or '' }}</td>
        <td contenteditable="true" data-field="notes">{{ entry.notes or '' }}</td>
        <td>
          <button class="save-btn" onclick="saveRow(this)">Save</button>
          <button onclick="deleteRow(this)">Del</button>
        </td>
      </tr>
      {% endfor %}

    </tbody>
  </table>

</div>

<script>
document.getElementById('input-date').valueAsDate = new Date();

calculateRunningBalance();

function calculateRunningBalance() {
  const tbody = document.querySelector('#cashflow-table tbody');
  const rows = Array.from(tbody.querySelectorAll('tr:not(#input-row)'));

  // Sort NEWEST -> OLDEST (oldest last)
  rows.sort((a, b) =>
    new Date(b.querySelector('[data-field="date"]').textContent) -
    new Date(a.querySelector('[data-field="date"]').textContent)
  );

  // Calculate running balance from bottom (oldest) upward
  let running = 0;
  for (let i = rows.length - 1; i >= 0; i--) {
    const amt = parseFloat(rows[i].querySelector('[data-field="amount"]').textContent) || 0;
    running += amt;
    rows[i].querySelector('.balance-cell').textContent = running.toFixed(2);
  }

  // Reinsert rows in newest->oldest order
  rows.forEach(row => tbody.appendChild(row));
}
</script>

</body>
</html>
