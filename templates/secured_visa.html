<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="theme-color" content="#F2EBDD">
  <title>Secured Visa Ledger</title>

  <style>
    body {
      font-family: Segoe UI, Tahoma, sans-serif;
      background: #9CAF88;
      padding: 24px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      border: 1px solid #9E9E9E;
    }
    .excel-header {
      background: #4A6741;
      color: #fff;
      padding: 14px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    .export-btn, .account-btn {
      color: #fff;
      border: 1px solid #fff;
      padding: 4px 10px;
      text-decoration: none;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
    }
    .export-btn:hover, .account-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11.5pt;
    }
    th, td {
      border: 1px solid #C0C0C0;
      padding: 6px 8px;
    }
    thead {
      background: #4A6741;
      color: #fff;
    }
    tbody tr:nth-child(odd):not(#input-row) { background: #A8CC9E; }
    tbody tr:nth-child(even):not(#input-row) { background: #E8F5C4; }
    .number { text-align: right; font-family: Courier New, monospace; }
    #input-row { background: #DCE6F1; }
    #input-row input {
      width: 100%;
      border: 1px solid #999;
      padding: 4px;
      font-size: 11pt;
    }
    .save-btn, .del-btn {
      padding: 2px 8px;
      font-size: 10px;
      cursor: pointer;
      margin-right: 4px;
    }
    .save-btn {
      background: #4A6741;
      color: white;
      border: 1px solid #3a5331;
    }
    .del-btn {
      background: #d32f2f;
      color: white;
      border: 1px solid #b71c1c;
    }
    .save-btn:hover { background: #5a7751; }
    .del-btn:hover { background: #e53935; }
    .save-btn[style*="display: none"] { display: none !important; }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    [contenteditable="true"]:focus {
      outline: 2px solid #4A6741;
      background: #fff9c4 !important;
    }
  </style>
</head>

<body>
<div class="container">

  <div class="excel-header">
    Cash Flow Ledger - Secured Visa
    <div class="header-buttons">
      <a href="/cashflow" class="account-btn">Bank Account</a>
      <a href="/export-csv?account_type=secured_visa" class="export-btn">Export CSV</a>
    </div>
  </div>

  <table id="cashflow-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Amount</th>
        <th>Running Balance</th>
        <th>Description</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>

      <tr id="input-row">
        <td><input id="input-date" type="date"></td>
        <td><input id="input-amount" type="number" step="0.01" placeholder="0.00"></td>
        <td></td>
        <td><input id="input-description" placeholder="Description"></td>
        <td><input id="input-notes" placeholder="Notes"></td>
        <td></td>
      </tr>

      {% for item in entries_with_balance %}
      <tr data-id="{{ item.entry.id }}">
        <td contenteditable="true" data-field="date" data-original="{{ item.entry.date.strftime('%Y-%m-%d') }}">{{ item.entry.date.strftime('%Y-%m-%d') }}</td>
        <td contenteditable="true" class="number" data-field="amount" data-original="{{ '%.2f'|format(item.entry.amount) }}">{{ "%.2f"|format(item.entry.amount) }}</td>
        <td class="number balance-cell">{{ "%.2f"|format(item.balance) }}</td>
        <td contenteditable="true" data-field="description" data-original="{{ item.entry.description or '' }}">{{ item.entry.description or '' }}</td>
        <td contenteditable="true" data-field="notes" data-original="{{ item.entry.notes or '' }}">{{ item.entry.notes or '' }}</td>
        <td>
          <button class="save-btn" style="display: none;" onclick="saveRow(this)">Save</button>
          <button class="del-btn" onclick="deleteRow(this)">Del</button>
        </td>
      </tr>
      {% endfor %}

    </tbody>
  </table>

</div>

<script>
document.getElementById('input-date').valueAsDate = new Date();

// Add entry on Enter key
document.getElementById('input-row').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    addEntry();
  }
});

// Detect changes in editable cells
document.querySelectorAll('tbody tr:not(#input-row)').forEach(row => {
  row.querySelectorAll('[contenteditable="true"]').forEach(cell => {
    cell.addEventListener('input', function() {
      const saveBtn = this.closest('tr').querySelector('.save-btn');
      const original = this.getAttribute('data-original');
      const current = this.textContent.trim();
      
      if (current !== original) {
        saveBtn.style.display = 'inline-block';
      } else {
        // Check if any other cell in this row has changes
        const hasChanges = Array.from(this.closest('tr').querySelectorAll('[contenteditable="true"]'))
          .some(c => c.textContent.trim() !== c.getAttribute('data-original'));
        
        if (!hasChanges) {
          saveBtn.style.display = 'none';
        }
      }
    });
  });
});

function addEntry() {
  const date = document.getElementById('input-date').value;
  const amount = document.getElementById('input-amount').value;
  const description = document.getElementById('input-description').value;
  const notes = document.getElementById('input-notes').value;
  
  if (!date || !amount) {
    alert('Date and amount are required');
    return;
  }
  
  const data = { date, amount, description, notes, account_type: 'secured_visa' };
  
  document.body.classList.add('loading');
  
  fetch('/add-ajax', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.error || 'Unknown error'); });
    }
    return response.json();
  })
  .then(result => {
    location.reload();
  })
  .catch(error => {
    document.body.classList.remove('loading');
    alert('Error adding entry: ' + error.message);
  });
}

function saveRow(button) {
  const row = button.closest('tr');
  const entryId = row.getAttribute('data-id');
  
  const dateCell = row.querySelector('[data-field="date"]');
  const amountCell = row.querySelector('[data-field="amount"]');
  const descCell = row.querySelector('[data-field="description"]');
  const notesCell = row.querySelector('[data-field="notes"]');
  
  const data = {
    date: dateCell.textContent.trim(),
    amount: amountCell.textContent.trim(),
    description: descCell.textContent.trim(),
    notes: notesCell.textContent.trim()
  };
  
  row.classList.add('loading');
  
  fetch(`/update/${entryId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.error || 'Unknown error'); });
    }
    return response.json();
  })
  .then(result => {
    // Update original values
    dateCell.setAttribute('data-original', data.date);
    amountCell.setAttribute('data-original', parseFloat(data.amount).toFixed(2));
    descCell.setAttribute('data-original', data.description);
    notesCell.setAttribute('data-original', data.notes);
    
    // Hide save button
    button.style.display = 'none';
    row.classList.remove('loading');
    
    // Reload to recalculate balances
    location.reload();
  })
  .catch(error => {
    row.classList.remove('loading');
    alert('Error saving changes: ' + error.message);
  });
}

function deleteRow(button) {
  if (!confirm('Are you sure you want to delete this entry?')) {
    return;
  }
  
  const row = button.closest('tr');
  const entryId = row.getAttribute('data-id');
  
  row.classList.add('loading');
  
  fetch(`/delete/${entryId}`, {
    method: 'DELETE'
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.error || 'Unknown error'); });
    }
    return response.json();
  })
  .then(result => {
    row.remove();
    location.reload();
  })
  .catch(error => {
    row.classList.remove('loading');
    alert('Error deleting entry: ' + error.message);
  });
}
</script>

</body>
</html>