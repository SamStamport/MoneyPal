<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="theme-color" content="#F2EBDD">
  <title>Cash Flow Charts</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    body {
      font-family: Segoe UI, Tahoma, sans-serif;
      background: #9CAF88;
      padding: 24px;
      margin: 0;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: #E8F5C4;
      border: 1px solid #9E9E9E;
    }
    .excel-header {
      background: #4A6741;
      color: #fff;
      padding: 14px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    .nav-btn {
      color: #fff;
      border: 1px solid #fff;
      padding: 4px 10px;
      text-decoration: none;
      font-size: 11px;
      cursor: pointer;
      background: transparent;
    }
    .nav-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    .chart-container {
      padding: 20px;
    }
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #4A6741;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #4A6741;
    }
    .chart-description {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }
    #cashflow-chart {
      width: 100%;
      height: 600px;
    }
    .info-box {
      background: #E8F5C4;
      border: 1px solid #9CAF88;
      padding: 15px;
      margin: 20px;
      border-radius: 4px;
    }
    .info-box h3 {
      margin-top: 0;
      color: #4A6741;
    }
    .info-box ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .info-box li {
      margin: 5px 0;
    }
    .thumb-tooltip {
      position: absolute;
      transform: translate(-50%, -140%);
      background: #4A6741;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0.95;
    }
    .double-range input[type=range]:focus::-webkit-slider-thumb { box-shadow: 0 0 0 4px rgba(74,103,65,0.12); }
    /* Custom double-thumb slider styling */
    .custom-range-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 18px;
      background: #f3f3f3;
      border-top: 1px solid #d0d0d0;
    }
    .mini-controls { display: flex; gap: 6px; }
    .mini-controls button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #999;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    .mini-controls button.locked { background:#4A6741; color:#fff; border-color:#3a5331 }
    .mini-controls button:hover { background: #eee; }
    .double-range {
      position: relative;
      width: 100%;
      height: 28px;
      display: flex;
      align-items: center;
    }
    .double-range input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      position: absolute;
      left: 0; right: 0;
      margin: 0;
      pointer-events: auto;
      height: 28px;
      background: transparent;
      z-index: 1;
    }
    .double-range input[type=range]::-webkit-slider-runnable-track { height: 8px; background: #ddd; border-radius: 6px; }
    .double-range input[type=range]::-moz-range-track { height: 8px; background: #ddd; border-radius: 6px; }
    .double-range input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      pointer-events: auto;
      width: 18px; height: 18px; border-radius: 50%; background: linear-gradient(#6aa26a,#4A6741); border: 2px solid #e9efe9; margin-top: -5px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .double-range input[type=range]::-moz-range-thumb {
      pointer-events: auto;
      width: 18px; height: 18px; border-radius: 50%; background: linear-gradient(#6aa26a,#4A6741); border: 2px solid #e9efe9; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    /* Highlighted selected range */
    .range-highlight {
      position: absolute;
      height: 8px;
      background: linear-gradient(90deg,#cfe9d0,#a8d5a1);
      border-radius: 6px;
      left: 0; right: 0;
      pointer-events: none;
    }
    .thumb-label {
      position: absolute;
      transform: translate(-50%, -220%);
      font-size: 11px;
      color: #222;
      background: transparent;
      padding: 0 4px;
      pointer-events: none;
    }
  </style>
</head>

<body>
<div class="container">

  <div class="excel-header">
    Cash Flow Analysis & Projections
    <span style="margin: 0 20px; padding: 4px 8px; border-radius: 4px; font-size: 10px; background: {{ 'red' if current_db_mode == 'LIVE' else 'green' }}; color: white;">
      {{ '[LIVE]' if current_db_mode == 'LIVE' else '[SAMPLE]' }}
    </span>
    <div class="nav-buttons">
      <button onclick="switchDatabase()" class="nav-btn">Switch DB</button>
      <a href="/cashflow" class="nav-btn">Bank Account</a>
      <a href="/secured-visa" class="nav-btn">Secured Visa</a>
      <a href="/charts" class="nav-btn">Charts</a>
    </div>
  </div>

  <div class="info-box">
    <h3>About This Chart</h3>
    <ul>
      <li><strong>Solid lines</strong> show actual historical balance data</li>
      <li><strong>Dashed lines</strong> show projected future balances (next 30 days)</li>
      <li><strong>Date range slider</strong> at the bottom controls the visible date range - use the slider, mini controls, or date inputs to adjust historical data</li>
      <li><strong>Keyboard:</strong> focus a thumb and use arrow keys to nudge; PageUp/PageDown to jump larger steps</li>
      <li><strong>Persistence:</strong> the last selected window is remembered between visits</li>
      <li><strong>Tooltips:</strong> drag a thumb to see exact dates while moving</li>
      <li><strong>Blue</strong> = Bank Account | <strong>Red</strong> = Secured Visa</li>
      <li><strong>Projection Accuracy:</strong> Bank Account: {{ bank_accuracy }}% | Secured Visa: {{ visa_accuracy }}%</li>
      <li>Use date inputs below to adjust historical data range</li>
    </ul>
  </div>

  <div class="chart-container">
    <div class="chart-title">Combined Cash Flow with 30-Day Projections</div>
    <div style="text-align: center; margin-bottom: 15px;">
      <label style="margin-right: 10px; font-weight: bold;">Historical Data Range:</label>
      <input type="date" id="start-date" onchange="updateDateRange()" style="padding: 5px; margin-right: 10px;">
      <span style="margin: 0 5px;">to</span>
      <input type="date" id="end-date" onchange="updateDateRange()" style="padding: 5px; margin-right: 10px;">
      <button onclick="resetDateRange()" style="padding: 5px 10px; margin-left: 10px;">Reset Range</button>
    </div>
    <div style="text-align: center; margin-bottom: 14px;">
      <label style="margin-right: 10px; font-weight: bold;">Toggle Series:</label>
      <button id="btn-bank" class="toggle-btn" onclick="toggleSeries('bank')">Bank Account</button>
      <button id="btn-visa" class="toggle-btn" onclick="toggleSeries('visa')">Secured Visa</button>
      <button id="btn-combined" class="toggle-btn" onclick="toggleSeries('combined')">Combined Total</button>
    </div>
    <div class="chart-description">
      Historical balances and future projections for both accounts
    </div>
    <div id="cashflow-chart"></div>

    <div class="custom-range-container">
      <div class="mini-controls">
        <button id="btn-first" title="To start"><<</button>
        <button id="btn-step-left" title="Step left">&lt;</button>
        <button id="btn-step-right" title="Step right">&gt;</button>
        <button id="btn-last" title="To end">>></button>
        <button id="btn-lock" title="Lock window">Lock</button>
      </div>

      <div class="double-range" style="flex:1;">
          <div class="range-highlight" id="range-highlight"></div>
          <div id="thumb-tooltip-left" class="thumb-tooltip" style="display:none">—</div>
          <div id="thumb-tooltip-right" class="thumb-tooltip" style="display:none">—</div>
          <div id="thumb-label-left" class="thumb-label" style="display:none">—</div>
          <div id="thumb-label-right" class="thumb-label" style="display:none">—</div>
          <input id="range-left" type="range" min="0" max="100" value="0" tabindex="0">
          <input id="range-right" type="range" min="0" max="100" value="100" tabindex="0">
      </div>
      <div style="width:120px; text-align:right; font-size:12px; color:#333;">
        <div id="range-label-start">—</div>
        <div id="range-label-end">—</div>
      </div>
    </div>
  </div>

</div>

<script>
// Get data from Flask
const bankData = {{ bank_data | safe }};
const visaData = {{ visa_data | safe }};
const combinedData = {{ combined_data | safe }};
const bankProjection = {{ bank_projection | safe }};
const visaProjection = {{ visa_projection | safe }};
const combinedProjection = {{ combined_projection | safe }};

// Date range controls
let startDate = null;
let endDate = null;

// Toggle button state
const activeSeries = { bank: true, visa: true, combined: true };

// Toggle button styles
const styleSheet = document.createElement('style');
styleSheet.textContent = `
  .toggle-btn { margin: 0 6px; padding: 6px 10px; border-radius: 4px; border: 1px solid #666; background: #fff; cursor: pointer; font-weight: 600; }
  .toggle-btn.active { background: #4A6741; color: #fff; border-color: #4A6741; }
`;
document.head.appendChild(styleSheet);

// Initialize date range
if (combinedData.length > 0) {
  startDate = new Date(combinedData[0].date);
  endDate = new Date(combinedData[combinedData.length - 1].date);
}

// Filter data function
function getFilteredData() {
  if (!startDate || !endDate) return { bankData, visaData, combinedData };
  
  const filteredBank = bankData.filter(d => {
    const date = new Date(d.date);
    return date >= startDate && date <= endDate;
  });
  
  const filteredVisa = visaData.filter(d => {
    const date = new Date(d.date);
    return date >= startDate && date <= endDate;
  });
  
  const filteredCombined = combinedData.filter(d => {
    const date = new Date(d.date);
    return date >= startDate && date <= endDate;
  });
  
  return { 
    bankData: filteredBank, 
    visaData: filteredVisa, 
    combinedData: filteredCombined 
  };
}

// Create chart
function createChart() {
  const { bankData: fBankData, visaData: fVisaData, combinedData: fCombinedData } = getFilteredData();
  const traces = [];

  // Bank account historical data
  if (fBankData.length > 0) {
    traces.push({
      x: fBankData.map(d => d.date),
      y: fBankData.map(d => d.balance),
      name: 'Bank Account',
      type: 'scatter',
      mode: 'lines',
      line: { color: '#2196F3', width: 3 },
      hovertemplate: '<b>Bank Account</b><br>Date: %{x}<br>Balance: $%{y:,.2f}<extra></extra>'
    });
  }

  // Bank account projection
  if (bankProjection.length > 0) {
    const lastBankBalance = fBankData.length > 0 ? fBankData[fBankData.length - 1].balance : 0;
    const lastBankDate = fBankData.length > 0 ? fBankData[fBankData.length - 1].date : bankProjection[0].date;
    
    traces.push({
      x: [lastBankDate, ...bankProjection.map(d => d.date)],
      y: [lastBankBalance, ...bankProjection.map(d => d.balance)],
      name: 'Bank Projection',
      type: 'scatter',
      mode: 'lines',
      line: { color: '#2196F3', width: 2, dash: 'dash' },
      hovertemplate: '<b>Bank Projection</b><br>Date: %{x}<br>Balance: $%{y:,.2f}<extra></extra>'
    });
  }

  // Secured Visa historical data
  if (fVisaData.length > 0) {
    traces.push({
      x: fVisaData.map(d => d.date),
      y: fVisaData.map(d => d.balance),
      name: 'Secured Visa',
      type: 'scatter',
      mode: 'lines',
      line: { color: '#F44336', width: 3 },
      hovertemplate: '<b>Secured Visa</b><br>Date: %{x}<br>Balance: $%{y:,.2f}<extra></extra>'
    });
  }

  // Combined total line
  if (fCombinedData.length > 0) {
    traces.push({
      x: fCombinedData.map(d => d.date),
      y: fCombinedData.map(d => d.balance),
      name: 'Combined Total',
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#4CAF50', width: 3 },
      marker: { symbol: 'cross', size: 8, color: '#4CAF50' },
      hovertemplate: '<b>Combined Total</b><br>Date: %{x}<br>Balance: $%{y:,.2f}<extra></extra>'
    });
  }

  // Secured Visa projection
  if (visaProjection.length > 0) {
    const lastVisaBalance = fVisaData.length > 0 ? fVisaData[fVisaData.length - 1].balance : 0;
    const lastVisaDate = fVisaData.length > 0 ? fVisaData[fVisaData.length - 1].date : visaProjection[0].date;
    
    traces.push({
      x: [lastVisaDate, ...visaProjection.map(d => d.date)],
      y: [lastVisaBalance, ...visaProjection.map(d => d.balance)],
      name: 'Visa Projection',
      type: 'scatter',
      mode: 'lines',
      line: { color: '#F44336', width: 2, dash: 'dash' },
      hovertemplate: '<b>Visa Projection</b><br>Date: %{x}<br>Balance: $%{y:,.2f}<extra></extra>'
    });
  }

  // Combined projection
  if (combinedProjection.length > 0) {
    const lastCombinedBalance = fCombinedData.length > 0 ? fCombinedData[fCombinedData.length - 1].balance : 0;
    const lastCombinedDate = fCombinedData.length > 0 ? fCombinedData[fCombinedData.length - 1].date : combinedProjection[0].date;
    
    traces.push({
      x: [lastCombinedDate, ...combinedProjection.map(d => d.date)],
      y: [lastCombinedBalance, ...combinedProjection.map(d => d.balance)],
      name: 'Combined Projection',
      type: 'scatter',
      mode: 'lines',
      line: { color: '#4CAF50', width: 2, dash: 'dash' },
      hovertemplate: '<b>Combined Projection</b><br>Date: %{x}<br>Balance: $%{y:,.2f}<extra></extra>'
    });
  }

  // Use Plotly's built-in horizontal range slider instead of vertical markers.
  // The range slider will appear under the x-axis and control the visible date range.
  // If a date range is set via the inputs, provide it to Plotly so the
  // rangeslider and x-axis reflect the same window.
  let xRange = undefined;
  if (startDate && endDate) {
    // Use ISO date strings (YYYY-MM-DD) which Plotly understands for date axes
    xRange = [startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]];
  }

  const layout = {
    xaxis: { 
      title: '<b>Date</b>', 
      gridcolor: '#E0E0E0', 
      showgrid: true,
      type: 'date',
      // Hide Plotly's built-in rangeslider; we'll provide a custom one below.
      rangeslider: { visible: false },
      range: xRange
    },
    yaxis: { title: '<b>Balance ($)</b>', gridcolor: '#E0E0E0', showgrid: true, tickformat: '$,.2f', rangemode: 'tozero' },
    hovermode: 'closest',
    plot_bgcolor: '#E8F5C4',
    paper_bgcolor: '#9CAF88',
    font: { family: 'Segoe UI, Tahoma, sans-serif', size: 14, color: '#000' },
    legend: { x: 0.01, y: 0.99, bgcolor: 'rgba(232,245,196,0.9)', bordercolor: '#999', borderwidth: 1 },
    margin: { l: 80, r: 40, t: 20, b: 60 }
  };

  const config = { responsive: true, displayModeBar: true, displaylogo: false };
  
    Plotly.newPlot('cashflow-chart', traces, layout, config).then(gd => {
    // Ensure buttons reflect initial active state
    updateToggleButtonStyles();
    // Adjust Y axis to current visible traces
    updateYAxis();

    // Update our custom slider positions to match startDate/endDate
    updateCustomRangeControls();

    // If user zooms/pans the chart directly, update the inputs and our custom slider
    gd.on('plotly_relayout', function(eventdata) {
      let r0 = null, r1 = null;
      if (eventdata['xaxis.range[0]'] && eventdata['xaxis.range[1]']) {
        r0 = eventdata['xaxis.range[0]'];
        r1 = eventdata['xaxis.range[1]'];
      } else if (eventdata['xaxis.range']) {
        const rg = eventdata['xaxis.range'];
        if (Array.isArray(rg) && rg.length >= 2) {
          r0 = rg[0]; r1 = rg[1];
        }
      }

      if (r0 && r1) {
        startDate = new Date(r0);
        endDate = new Date(r1);
        updateDateInputs();
        updateCustomRangeControls();
      }
    });
  });
}

// Helper: update toggle button CSS classes
function updateToggleButtonStyles() {
  document.getElementById('btn-bank').classList.toggle('active', activeSeries.bank);
  document.getElementById('btn-visa').classList.toggle('active', activeSeries.visa);
  document.getElementById('btn-combined').classList.toggle('active', activeSeries.combined);
}

// Toggle series visibility by key: 'bank' | 'visa' | 'combined'
function toggleSeries(key) {
  activeSeries[key] = !activeSeries[key];
  updateToggleButtonStyles();
  const gd = document.getElementById('cashflow-chart');
  if (!gd || !gd.data) return;

  // Determine which trace indices should be toggled
  const indices = [];
  gd.data.forEach((trace, i) => {
    const name = (trace.name || '').toLowerCase();
    if (name.includes('start date') || name.includes('end date')) return; // ignore vertical markers
    if (key === 'bank' && name.includes('bank')) indices.push(i);
    if (key === 'visa' && name.includes('visa')) indices.push(i);
    if (key === 'combined' && name.includes('combined')) indices.push(i);
  });

  // Set visibility for those indices
  if (indices.length > 0) {
    Plotly.restyle(gd, { visible: activeSeries[key] }, indices).then(() => {
      // After visibility change, recompute Y axis range
      updateYAxis();
    });
  }
}

// Recalculate Y axis range based on visible traces
function updateYAxis() {
  const gd = document.getElementById('cashflow-chart');
  if (!gd || !gd.data) return;

  const visibleYs = [];
  gd.data.forEach(trace => {
    // trace.visible may be undefined (default = true) or 'legendonly' or false
    const vis = (trace.visible === undefined) || trace.visible === true || trace.visible === 'true';
    if (!vis) return;
    if (!Array.isArray(trace.y)) return;
    trace.y.forEach(v => {
      if (typeof v === 'number' && isFinite(v)) visibleYs.push(v);
    });
  });

  if (visibleYs.length > 0) {
    const minY = Math.min(...visibleYs);
    const maxY = Math.max(...visibleYs);
    const pad = Math.max(10, (maxY - minY) * 0.12);
    Plotly.relayout(gd, { 'yaxis.range': [minY - pad, maxY + pad] });
  } else {
    // If nothing visible, reset autorange
    Plotly.relayout(gd, { 'yaxis.autorange': true });
  }
}

// Date range functions
function updateDateInputs() {
  if (startDate) {
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
  }
  if (endDate) {
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
  }
}

function updateDateRange() {
  const startInput = document.getElementById('start-date').value;
  const endInput = document.getElementById('end-date').value;
  
  if (startInput) startDate = new Date(startInput);
  if (endInput) endDate = new Date(endInput);
  
  if (startDate && endDate && startDate > endDate) {
    [startDate, endDate] = [endDate, startDate];
    updateDateInputs();
  }
  
  createChart();
}

function resetDateRange() {
  if (combinedData.length > 0) {
    startDate = new Date(combinedData[0].date);
    endDate = new Date(combinedData[combinedData.length - 1].date);
    updateDateInputs();
    createChart();
  }
}

function switchDatabase() {
  if (confirm('Switch database? This requires restarting the app.')) {
    fetch('/switch-database', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
      });
  }
}

// Initialize
if (combinedData.length > 0) {
  // Try to restore saved window; otherwise use full range
  if (!loadRangeFromStorage()) {
    startDate = new Date(combinedData[0].date);
    endDate = new Date(combinedData[combinedData.length - 1].date);
  }
  updateDateInputs();
}
createChart();
// ensure lock UI reflects loaded state
if (typeof lockedRange !== 'undefined') {
  try { const b = document.getElementById('btn-lock'); if (b) { if (lockedRange) b.classList.add('locked'); else b.classList.remove('locked'); b.textContent = lockedRange ? 'Locked' : 'Lock'; } } catch(e){}
}

// ----- Custom range controls (double-thumb slider + mini buttons) -----
let customControlsReady = false;
function setupCustomRangeControls() {
  if (customControlsReady) return;
  customControlsReady = true;

  const left = document.getElementById('range-left');
  const right = document.getElementById('range-right');
  const lblStart = document.getElementById('range-label-start');
  const lblEnd = document.getElementById('range-label-end');
  const highlight = document.getElementById('range-highlight');

  const btnFirst = document.getElementById('btn-first');
  const btnStepLeft = document.getElementById('btn-step-left');
  const btnStepRight = document.getElementById('btn-step-right');
  const btnLast = document.getElementById('btn-last');
  const btnLock = document.getElementById('btn-lock');
  const tooltipLeft = document.getElementById('thumb-tooltip-left');
  const tooltipRight = document.getElementById('thumb-tooltip-right');

  // Helper: clamp and ensure left < right
  function fixBounds() {
    let l = parseInt(left.value, 10);
    let r = parseInt(right.value, 10);
    if (l >= r) {
      if (r > 0) l = r - 1; else r = l + 1;
    }
    left.value = l;
    right.value = r;
  }

  function mmddyyyy(d) {
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }

  function updateHighlight() {
    const min = parseInt(left.min, 10);
    const max = parseInt(left.max, 10);
    const l = parseInt(left.value, 10);
    const r = parseInt(right.value, 10);
    const pctL = ((l - min) / (max - min)) * 100;
    const pctR = ((r - min) / (max - min)) * 100;
    highlight.style.left = pctL + '%';
    highlight.style.width = Math.max(2, pctR - pctL) + '%';
    // position tooltips near thumbs
    const containerRect = left.parentElement.getBoundingClientRect();
    const leftPx = containerRect.left + (pctL/100) * containerRect.width;
    const rightPx = containerRect.left + (pctR/100) * containerRect.width;
    if (tooltipLeft) tooltipLeft.style.left = pctL + '%';
    if (tooltipRight) tooltipRight.style.left = pctR + '%';
    const lblL = document.getElementById('thumb-label-left');
    const lblR = document.getElementById('thumb-label-right');
    if (lblL) lblL.style.left = pctL + '%';
    if (lblR) lblR.style.left = pctR + '%';
  }

  function updateLabelsAndApply() {
    const minDate = new Date(combinedData[0].date);
    const msDay = 24*60*60*1000;
    const l = parseInt(left.value, 10);
    const r = parseInt(right.value, 10);
    const d0 = new Date(minDate.getTime() + l * msDay);
    const d1 = new Date(minDate.getTime() + r * msDay);
    startDate = d0;
    endDate = d1;
    lblStart.textContent = d0.toISOString().split('T')[0];
    lblEnd.textContent = d1.toISOString().split('T')[0];
    updateDateInputs();
    saveRangeToStorage();
    // if lockedRange set, also save lock state
    try { localStorage.setItem('moneypal_charts_locked', lockedRange ? '1' : '0'); } catch (e) {}
    createChart();
  }

  left.addEventListener('input', function(e) {
    left.style.zIndex = 3;
    right.style.zIndex = 1;
    fixBounds();
    updateHighlight();
    // show/update tooltip
    const minDate = new Date(combinedData[0].date);
    const msDay = 24*60*60*1000;
    const d = new Date(minDate.getTime() + parseInt(left.value,10)*msDay);
    if (tooltipLeft) { tooltipLeft.style.display = 'block'; tooltipLeft.textContent = mmddyyyy(d); }
    const lblL = document.getElementById('thumb-label-left'); if (lblL) { lblL.style.display='block'; lblL.textContent = mmddyyyy(d); }
  });
  left.addEventListener('change', function() { fixBounds(); updateLabelsAndApply(); if (tooltipLeft) tooltipLeft.style.display='none'; });

  right.addEventListener('input', function(e) { right.style.zIndex = 3; left.style.zIndex = 1; fixBounds(); updateHighlight(); if (tooltipRight) { const minDate = new Date(combinedData[0].date); const msDay=24*60*60*1000; const d=new Date(minDate.getTime()+parseInt(right.value,10)*msDay); tooltipRight.style.display='block'; tooltipRight.textContent = mmddyyyy(d); const lblR = document.getElementById('thumb-label-right'); if (lblR) { lblR.style.display='block'; lblR.textContent = mmddyyyy(d); } } });
  right.addEventListener('change', function() { fixBounds(); updateLabelsAndApply(); if (tooltipRight) tooltipRight.style.display='none'; const lblR = document.getElementById('thumb-label-right'); if (lblR) lblR.style.display='none'; });

  // Keyboard accessibility for thumbs
  left.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') { e.preventDefault(); left.value = Math.max(parseInt(left.min,10), parseInt(left.value,10)-1); left.dispatchEvent(new Event('input')); }
    if (e.key === 'ArrowRight') { e.preventDefault(); left.value = Math.min(parseInt(left.max,10)-1, parseInt(left.value,10)+1); left.dispatchEvent(new Event('input')); }
    if (e.key === 'PageDown') { e.preventDefault(); left.value = Math.max(parseInt(left.min,10), parseInt(left.value,10)-10); left.dispatchEvent(new Event('input')); }
    if (e.key === 'PageUp') { e.preventDefault(); left.value = Math.min(parseInt(left.max,10)-1, parseInt(left.value,10)+10); left.dispatchEvent(new Event('input')); }
    if (e.key === 'Home') { e.preventDefault(); left.value = parseInt(left.min,10); left.dispatchEvent(new Event('input')); }
    if (e.key === 'End') { e.preventDefault(); left.value = Math.max(0, parseInt(right.value,10)-1); left.dispatchEvent(new Event('input')); }
    if (e.key === 'Enter') { left.dispatchEvent(new Event('change')); }
  });
  right.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') { e.preventDefault(); right.value = Math.max(parseInt(right.min,10), parseInt(right.value,10)-1); right.dispatchEvent(new Event('input')); }
    if (e.key === 'ArrowRight') { e.preventDefault(); right.value = Math.min(parseInt(right.max,10), parseInt(right.value,10)+1); right.dispatchEvent(new Event('input')); }
    if (e.key === 'PageDown') { e.preventDefault(); right.value = Math.max(parseInt(right.min,10), parseInt(right.value,10)-10); right.dispatchEvent(new Event('input')); }
    if (e.key === 'PageUp') { e.preventDefault(); right.value = Math.min(parseInt(right.max,10), parseInt(right.value,10)+10); right.dispatchEvent(new Event('input')); }
    if (e.key === 'Home') { e.preventDefault(); right.value = Math.min(parseInt(right.max,10), parseInt(left.value,10)+1); right.dispatchEvent(new Event('input')); }
    if (e.key === 'End') { e.preventDefault(); right.value = parseInt(right.max,10); right.dispatchEvent(new Event('input')); }
    if (e.key === 'Enter') { right.dispatchEvent(new Event('change')); }
  });

  btnFirst.addEventListener('click', function() {
    const span = parseInt(right.value,10) - parseInt(left.value,10);
    left.value = 0;
    right.value = Math.min(parseInt(left.max,10), span);
    updateHighlight();
    updateLabelsAndApply();
  });
  btnLast.addEventListener('click', function() {
    const span = parseInt(right.value,10) - parseInt(left.value,10);
    right.value = parseInt(left.max,10);
    left.value = Math.max(0, parseInt(right.value,10) - span);
    updateHighlight();
    updateLabelsAndApply();
  });
  btnStepLeft.addEventListener('click', function() {
    const l = Math.max(0, parseInt(left.value,10) - 1);
    const r = Math.max(l+1, parseInt(right.value,10) - 1);
    left.value = l; right.value = r; updateHighlight(); updateLabelsAndApply();
  });
  btnStepRight.addEventListener('click', function() {
    const max = parseInt(left.max,10);
    const r = Math.min(max, parseInt(right.value,10) + 1);
    const l = Math.min(r-1, parseInt(left.value,10) + 1);
    left.value = l; right.value = r; updateHighlight(); updateLabelsAndApply();
  });
  
  // Lock button toggles preservation of the current window when new data arrives
  let lockedRange = false;
  function updateLockUI() {
    if (!btnLock) return;
    if (lockedRange) btnLock.classList.add('locked'); else btnLock.classList.remove('locked');
    btnLock.textContent = lockedRange ? 'Locked' : 'Lock';
  }
  function saveLockToStorage() {
    try { localStorage.setItem('moneypal_charts_locked', lockedRange ? '1' : '0'); } catch (e) {}
  }
  function loadLockFromStorage() {
    try { const v = localStorage.getItem('moneypal_charts_locked'); lockedRange = v === '1'; } catch (e) { lockedRange = false; }
  }
  if (btnLock) {
    loadLockFromStorage(); updateLockUI();
    btnLock.addEventListener('click', function() { lockedRange = !lockedRange; updateLockUI(); saveLockToStorage(); });
  }
}

function updateCustomRangeControls() {
  // Ensure controls exist and combinedData available
  if (!combinedData || combinedData.length === 0) return;
  setupCustomRangeControls();
  const left = document.getElementById('range-left');
  const right = document.getElementById('range-right');
  const lblStart = document.getElementById('range-label-start');
  const lblEnd = document.getElementById('range-label-end');
  const highlight = document.getElementById('range-highlight');

  const minDate = new Date(combinedData[0].date);
  const maxDate = new Date(combinedData[combinedData.length-1].date);
  const msDay = 24*60*60*1000;
  const totalDays = Math.round((Date.UTC(maxDate.getFullYear(), maxDate.getMonth(), maxDate.getDate()) - Date.UTC(minDate.getFullYear(), minDate.getMonth(), minDate.getDate()))/msDay);

  left.min = 0; left.max = totalDays;
  right.min = 0; right.max = totalDays;

  // default to full range if startDate/endDate not set
  if (!startDate || !endDate) {
    left.value = 0;
    right.value = totalDays;
    lblStart.textContent = minDate.toISOString().split('T')[0];
    lblEnd.textContent = maxDate.toISOString().split('T')[0];
  } else {
    const l = Math.round((Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()) - Date.UTC(minDate.getFullYear(), minDate.getMonth(), minDate.getDate()))/msDay);
    const r = Math.round((Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate()) - Date.UTC(minDate.getFullYear(), minDate.getMonth(), minDate.getDate()))/msDay);
    left.value = Math.max(0, Math.min(totalDays, l));
    right.value = Math.max(0, Math.min(totalDays, r));
    lblStart.textContent = new Date(minDate.getTime() + left.value * msDay).toISOString().split('T')[0];
    lblEnd.textContent = new Date(minDate.getTime() + right.value * msDay).toISOString().split('T')[0];
  }

  // update highlight bar
  const pctL = ((left.value - left.min)/(left.max - left.min))*100;
  const pctR = ((right.value - left.min)/(left.max - left.min))*100;
  highlight.style.left = pctL + '%';
  highlight.style.width = Math.max(2, pctR - pctL) + '%';
}

// Persistence: save & load last chosen window
function saveRangeToStorage() {
  try {
    const key = 'moneypal_charts_range';
    const payload = { start: startDate ? startDate.toISOString().split('T')[0] : null, end: endDate ? endDate.toISOString().split('T')[0] : null };
    localStorage.setItem(key, JSON.stringify(payload));
    // also persist lock state if present
    try { localStorage.setItem('moneypal_charts_locked', lockedRange ? '1' : '0'); } catch (e) {}
  } catch (e) { /* ignore */ }
}

function loadRangeFromStorage() {
  try {
    const key = 'moneypal_charts_range';
    const raw = localStorage.getItem(key);
    if (!raw) return false;
    const obj = JSON.parse(raw);
    if (!obj || !obj.start || !obj.end) return false;
    const minDate = new Date(combinedData[0].date);
    const maxDate = new Date(combinedData[combinedData.length-1].date);
    const s = new Date(obj.start);
    const e = new Date(obj.end);
    if (isNaN(s.getTime()) || isNaN(e.getTime())) return false;
    if (s < minDate) s.setTime(minDate.getTime());
    if (e > maxDate) e.setTime(maxDate.getTime());
    startDate = s; endDate = e;
    // load locked state too
    try { const v = localStorage.getItem('moneypal_charts_locked'); lockedRange = v === '1'; } catch (e) { lockedRange = false; }
    return true;
  } catch (e) { return false; }
}
</script>

</body>
</html>